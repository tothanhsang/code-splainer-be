# üîç Phase 2: AI Code Review Assistant

## üéØ Overview

AI Code Review Assistant gi√∫p Tech Lead v√† developers th·ª±c hi·ªán code review t·ª± ƒë·ªông v·ªõi s·ª± hi·ªÉu bi·∫øt s√¢u s·∫Øc v·ªÅ to√†n b·ªô codebase.

### Key Features

‚úÖ **Context-Aware Review** - AI hi·ªÉu to√†n b·ªô project structure v√† conventions  
‚úÖ **Bug Detection** - Ph√°t hi·ªán l·ªói logic ti·ªÅm ·∫©n  
‚úÖ **Performance Analysis** - T√¨m c√°c v·∫•n ƒë·ªÅ v·ªÅ hi·ªáu nƒÉng  
‚úÖ **Security Check** - Ph√°t hi·ªán l·ªó h·ªïng b·∫£o m·∫≠t  
‚úÖ **Convention Compliance** - Ki·ªÉm tra tu√¢n th·ªß coding style  
‚úÖ **Improvement Suggestions** - G·ª£i √Ω c·∫£i thi·ªán code quality  

---

## üöÄ Quick Start

### 1. Start Server

```bash
cd code-splainer-be
pnpm install
pnpm dev
```

### 2. Upload Project Context

```bash
# Prepare your codebase
zip -r my-project.zip . -x "node_modules/*" ".git/*" "dist/*"

# Upload to AI
curl -X POST http://localhost:3001/api/code-review/upload-context \
  -F "codebase=@my-project.zip"

# Save the contextId from response
```

### 3. Review Your Changes

```bash
# Create diff file
git diff > my-changes.patch

# Get AI review
curl -X POST http://localhost:3001/api/code-review/review-changes \
  -F "contextId=YOUR_CONTEXT_ID" \
  -F "changeDescription=Fixed authentication bug" \
  -F "changes=@my-changes.patch"
```

---

## üè≠ Code Structure

```
src/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ database.ts          # Prisma client (Phase 1 only)
‚îÇ   ‚îú‚îÄ‚îÄ redis.ts             # Redis client for context storage
‚îÇ   ‚îî‚îÄ‚îÄ gemini.ts            # Genkit + Gemini AI (gemini-2.5-pro)
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îú‚îÄ‚îÄ specAnalyzer.controller.ts  # Phase 1 controller
‚îÇ   ‚îî‚îÄ‚îÄ codeReview.controller.ts    # Phase 2 controller ‚≠ê
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ pdfParser.service.ts        # Phase 1 PDF parsing
‚îÇ   ‚îú‚îÄ‚îÄ aiAnalysis.service.ts       # Phase 1 AI analysis
‚îÇ   ‚îú‚îÄ‚îÄ zipParser.service.ts        # Phase 2 ZIP parsing ‚≠ê
‚îÇ   ‚îî‚îÄ‚îÄ codeReview.service.ts       # Phase 2 AI review ‚≠ê
‚îú‚îÄ‚îÄ prompts/
‚îÇ   ‚îú‚îÄ‚îÄ specAnalysis.prompt.ts      # Phase 1 prompts
‚îÇ   ‚îî‚îÄ‚îÄ codeReview.prompt.ts        # Phase 2 prompts ‚≠ê
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ api.routes.ts               # All API routes
‚îî‚îÄ‚îÄ server.ts                       # Express server
```

**Phase 2 Files (‚≠ê):**
- `codeReview.controller.ts` - 404 lines - HTTP request handling
- `codeReview.service.ts` - 381 lines - Business logic & AI integration
- `zipParser.service.ts` - ~200 lines - ZIP/PATCH file parsing
- `codeReview.prompt.ts` - 161 lines - Centralized prompt templates

---

## üìä Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Phase 2 Architecture                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 1. Upload codebase.zip
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Controller          ‚îÇ
‚îÇ  codeReview.controller‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 2. Extract files
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ZIP Parser Service  ‚îÇ
‚îÇ  zipParser.service   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 3. Store context
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Code Review Service ‚îÇ
‚îÇ  codeReview.service  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 4. Store in Redis
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      Redis           ‚îÇ
‚îÇ  (Context Storage)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ Client uploads  ‚îÇ
       ‚îÇ changes.patch   ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚îÇ 5. Review request
                ‚Üì
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ  Controller        ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚îÇ 6. Get context
                ‚Üì
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ  Redis             ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚îÇ 7. Build prompt
                ‚Üì
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ  Prompt Template   ‚îÇ
       ‚îÇ  codeReview.prompt ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚îÇ 8. AI Review
                ‚Üì
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ  Genkit + Gemini   ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚îÇ 9. Structured output
                ‚Üì
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ  Review Result     ‚îÇ
       ‚îÇ  (JSON)            ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìÅ File Structure

```
src/
‚îú‚îÄ‚îÄ prompts/
‚îÇ   ‚îî‚îÄ‚îÄ codeReview.prompt.ts      # Centralized prompt template
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ zipParser.service.ts      # ZIP file extraction
‚îÇ   ‚îî‚îÄ‚îÄ codeReview.service.ts     # AI review logic
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ codeReview.controller.ts  # HTTP endpoints
‚îî‚îÄ‚îÄ routes/
    ‚îî‚îÄ‚îÄ api.routes.ts              # API routing
```

---

## üîß Implementation Details

### 1. Prompt Template (`codeReview.prompt.ts`)

```typescript
export const CODE_REVIEW_PROMPT = ({
  projectContext,
  changesContent,
  changeDescription,
}: CodeReviewPromptParams): string => `
B·∫°n l√† m·ªôt Tech Lead v·ªõi 10 nƒÉm kinh nghi·ªám...

--- NG·ªÆ C·∫¢NH TO√ÄN B·ªò D·ª∞ √ÅN ---
${projectContext}
--- K·∫æT TH√öC NG·ªÆ C·∫¢NH ---

--- N·ªòI DUNG THAY ƒê·ªîI (DIFF) ---
${changesContent}
--- K·∫æT TH√öC THAY ƒê·ªîI ---

Tr·∫£ v·ªÅ JSON v·ªõi:
- potentialBugs
- performanceIssues
- securityVulnerabilities
- conventionViolations
- improvements
`;
```

### 2. ZIP Parser Service

```typescript
class ZipParserService {
  // Extract all text files from ZIP
  async extractAllFiles(file: UploadedFile): Promise<Array<{path, content}>>
  
  // Parse diff/patch files
  parseDiffFile(content: string): Array<{file, changes}>
  
  // Skip binary files and build directories
  private shouldSkipFile(filename: string): boolean
}
```

### 3. Code Review Service

```typescript
class CodeReviewService {
  // Main review method
  async reviewCode(
    projectFiles: Array<{path, content}>,
    changedFiles: Array<{path, content, isDiff}>,
    changeDescription: string
  ): Promise<CodeReviewResult>
  
  // Store/retrieve context from Redis
  async storeProjectContext(files): Promise<contextId>
  async getProjectContext(contextId): Promise<context>
}
```

### 4. Genkit Flow

```typescript
export const codeReviewFlow = ai.defineFlow(
  {
    name: 'codeReview',
    inputSchema: CodeReviewInput,
    outputSchema: CodeReviewSchema, // Zod validation
  },
  async ({ projectContext, changesContent, changeDescription }) => {
    const prompt = CODE_REVIEW_PROMPT({...});
    const llmResponse = await ai.generate(prompt);
    return CodeReviewSchema.parse(JSON.parse(llmResponse.text));
  }
);
```

---

## üéØ API Endpoints

### 1. Upload Context
```
POST /api/code-review/upload-context
Body: codebase (ZIP file)
Response: { contextId, stats }
```

### 2. Review Changes
```
POST /api/code-review/review-changes
Body: contextId, changeDescription, changes (ZIP or .patch)
Response: { review, stats, filesReviewed }
```

### 3. Quick Review
```
POST /api/code-review/quick-review
Body: codebase (ZIP), changes (ZIP or .patch), changeDescription
Response: { review, stats, projectStats }
```

---

## üìä Review Output Example

```json
{
  "overallQuality": "Code changes are good with minor issues",
  "summary": {
    "totalIssues": 5,
    "criticalIssues": 1,
    "filesReviewed": 3
  },
  "potentialBugs": [
    {
      "file": "src/cart.service.ts",
      "line": 45,
      "severity": "high",
      "issue": "Potential null pointer exception",
      "suggestion": "Add null check"
    }
  ],
  "performanceIssues": [...],
  "securityVulnerabilities": [...],
  "conventionViolations": [...],
  "improvements": [...],
  "positivePoints": [
    "Good error handling",
    "Well-structured code"
  ]
}
```

---

## üß™ Testing

### Test Upload Context

```bash
# Create test project
mkdir test-project
cd test-project
echo "function hello() { console.log('Hello'); }" > index.js
zip -r ../test-project.zip .

# Upload
curl -X POST http://localhost:3001/api/code-review/upload-context \
  -F "codebase=@test-project.zip"
```

### Test Review Changes

```bash
# Create changes
echo "function hello() { console.log('Hi'); }" > index.js
git diff > changes.patch

# Review
curl -X POST http://localhost:3001/api/code-review/review-changes \
  -F "contextId=YOUR_ID" \
  -F "changeDescription=Updated greeting" \
  -F "changes=@changes.patch"
```

---

## üí° Best Practices

### 1. Codebase Preparation

```bash
# Good: Exclude unnecessary files
zip -r codebase.zip . \
  -x "node_modules/*" \
  -x ".git/*" \
  -x "dist/*" \
  -x "build/*"

# Bad: Include everything
zip -r codebase.zip .
```

### 2. Change Description

**Good:**
```
"Added user authentication with JWT. 
Implemented login/logout endpoints.
Used bcrypt for password hashing."
```

**Bad:**
```
"Updated files"
```

### 3. Diff Format

```bash
# Use standard Git diff
git diff > changes.patch

# Or specific files
git diff -- src/auth.ts src/user.ts > changes.patch
```

---

## üîç Review Categories

### 1. Potential Bugs
- Null pointer exceptions
- Undefined variables
- Logic errors
- Edge cases not handled

### 2. Performance Issues
- N+1 queries
- Inefficient loops
- Memory leaks
- Slow algorithms

### 3. Security Vulnerabilities
- SQL injection
- XSS attacks
- Insecure data handling
- Missing authentication

### 4. Convention Violations
- Naming conventions
- Code style
- Project patterns
- Best practices

### 5. Improvements
- Refactoring suggestions
- Code simplification
- Better abstractions
- Maintainability tips

---

## üöÄ Deployment

### Environment Variables

```env
# Required
GOOGLE_API_KEY=your_gemini_api_key

# Optional
MAX_ZIP_SIZE=52428800  # 50MB
REDIS_HOST=localhost
REDIS_PORT=6379
```

### Production Checklist

- [ ] Set appropriate MAX_ZIP_SIZE
- [ ] Configure Redis for context storage
- [ ] Set up monitoring for AI API calls
- [ ] Implement rate limiting
- [ ] Add authentication if needed

---

## üìö Documentation

- [API Documentation](./docs/PHASE2-API.md)
- [Phase 1 Guide](./docs/04-phase1-guide.md)
- [Genkit Guide](./docs/05-genkit-guide.md)

---

## üéâ Summary

Phase 2 provides powerful AI-powered code review capabilities:

‚úÖ **Context-aware** - Understands entire project  
‚úÖ **Comprehensive** - Checks bugs, performance, security, conventions  
‚úÖ **Actionable** - Provides specific suggestions  
‚úÖ **Fast** - Cached results for repeated reviews  
‚úÖ **Flexible** - Two-step or one-step workflow  

Ready to improve your code quality! üöÄ
